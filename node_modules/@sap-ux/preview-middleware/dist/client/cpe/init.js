"use strict";

sap.ui.define(["sap/base/Log", "open/ux/preview/client/thirdparty/@sap-ux-private/control-property-editor-common", "../utils/error", "./changes/service", "./communication-service", "./connector-service", "./context-menu-service", "./documentation", "./outline/service", "./quick-actions/quick-action-service", "./rta-service", "./selection", "./ui5-utils", "./odata-health/odata-health-checker", "../utils/info-center-message", "./odata-health/odata-health-status"], function (Log, ___sap_ux_private_control_property_editor_common, ___utils_error, ___changes_service, ___communication_service, ___connector_service, ___context_menu_service, ___documentation, ___outline_service, ___quick_actions_quick_action_service, ___rta_service, ___selection, ___ui5_utils, ___odata_health_odata_health_checker, ___utils_info_center_message, ___odata_health_odata_health_status) {
  "use strict";

  const appLoaded = ___sap_ux_private_control_property_editor_common["appLoaded"];
  const enableTelemetry = ___sap_ux_private_control_property_editor_common["enableTelemetry"];
  const iconsLoaded = ___sap_ux_private_control_property_editor_common["iconsLoaded"];
  const MessageBarType = ___sap_ux_private_control_property_editor_common["MessageBarType"];
  const getError = ___utils_error["getError"];
  const ChangeService = ___changes_service["ChangeService"];
  const CommunicationService = ___communication_service["CommunicationService"];
  const WorkspaceConnectorService = ___connector_service["WorkspaceConnectorService"];
  const ContextMenuService = ___context_menu_service["ContextMenuService"];
  const loadDefaultLibraries = ___documentation["loadDefaultLibraries"];
  const OutlineService = ___outline_service["OutlineService"];
  const QuickActionService = ___quick_actions_quick_action_service["QuickActionService"];
  const RtaService = ___rta_service["RtaService"];
  const SelectionService = ___selection["SelectionService"];
  const getIcons = ___ui5_utils["getIcons"];
  const ODataHealthChecker = ___odata_health_odata_health_checker["ODataHealthChecker"];
  const sendInfoCenterMessage = ___utils_info_center_message["sendInfoCenterMessage"];
  const ODataUpStatus = ___odata_health_odata_health_status["ODataUpStatus"];
  /**
   * Subscribes a handler to the CommunicationService
   *
   * @param handler action handler
   */
  function subscribe(handler) {
    CommunicationService.subscribe(handler);
  }
  function init(rta, registries = []) {
    Log.info('Initializing Control Property Editor');

    // enable telemetry if requested
    const flexSettings = rta.getFlexSettings();
    if (flexSettings.telemetry === true) {
      enableTelemetry();
    }
    const rtaService = new RtaService(rta);
    const changesService = new ChangeService({
      rta
    });
    const selectionService = new SelectionService(rta, changesService);
    const connectorService = new WorkspaceConnectorService();
    const contextMenuService = new ContextMenuService(rta);
    const outlineService = new OutlineService(rta, changesService);
    const quickActionService = new QuickActionService(rta, outlineService, registries, changesService);
    const services = [connectorService, selectionService, changesService, contextMenuService, outlineService, rtaService, quickActionService];

    // Do health check to all available oData service instances.
    const oDataHealthChecker = new ODataHealthChecker(rta);
    oDataHealthChecker.getHealthStatus().then(healthStatus => healthStatus.map(status => status instanceof ODataUpStatus ? Promise.resolve() : sendInfoCenterMessage({
      title: {
        key: 'ADP_ODATA_HEALTH_CHECK_TITLE'
      },
      description: {
        key: 'ADP_ODATA_SERVICE_DOWN_DESCRIPTION',
        params: [status.serviceUrl, status.errorMessage]
      },
      type: MessageBarType.warning
    }))).catch(error => sendInfoCenterMessage({
      title: {
        key: 'ADP_ODATA_HEALTH_CHECK_TITLE'
      },
      description: getError(error).message,
      type: MessageBarType.warning
    }));
    try {
      loadDefaultLibraries();
      const allPromises = services.map(service => {
        return service.init(CommunicationService.sendAction, subscribe)?.catch(error => {
          Log.error('Service Initialization Failed: ', getError(error));
        });
      }).filter(p => p !== undefined);
      Promise.all(allPromises).then(() => {
        CommunicationService.sendAction(appLoaded());
      })
      // eslint-disable-next-line @typescript-eslint/unbound-method
      .catch(Log.error);
      const icons = getIcons();
      CommunicationService.sendAction(iconsLoaded(icons));
    } catch (error) {
      Log.error('Error during initialization of Control Property Editor', getError(error));
    }

    //  * This is returned immediately to avoid promise deadlock, preventing services from waiting indefinitely.
    return Promise.resolve();
  }
  return init;
});
//# sourceMappingURL=init.js.map