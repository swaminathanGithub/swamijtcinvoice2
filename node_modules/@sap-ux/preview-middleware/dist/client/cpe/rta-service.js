"use strict";

sap.ui.define(["open/ux/preview/client/thirdparty/@sap-ux-private/control-property-editor-common"], function (___sap_ux_private_control_property_editor_common) {
  "use strict";

  const setAppMode = ___sap_ux_private_control_property_editor_common["setAppMode"];
  const setUndoRedoEnablement = ___sap_ux_private_control_property_editor_common["setUndoRedoEnablement"];
  const setSaveEnablement = ___sap_ux_private_control_property_editor_common["setSaveEnablement"];
  const undo = ___sap_ux_private_control_property_editor_common["undo"];
  const redo = ___sap_ux_private_control_property_editor_common["redo"];
  const save = ___sap_ux_private_control_property_editor_common["save"];
  const reloadApplication = ___sap_ux_private_control_property_editor_common["reloadApplication"];
  const applicationModeChanged = ___sap_ux_private_control_property_editor_common["applicationModeChanged"];
  /**
   * A Class of RtaService
   */
  class RtaService {
    /**
     *
     * @param rta Runtime Authoring Instance
     */
    constructor(rta) {
      this.rta = rta;
    }

    /**
     * Initializes rta service.
     *
     * @param sendAction action sender function
     * @param subscribe subscriber function
     */
    async init(sendAction, subscribe) {
      return new Promise(resolve => {
        sendAction(applicationModeChanged(this.rta.getMode()));
        subscribe(async action => {
          if (setAppMode.match(action)) {
            this.rta.setMode(action.payload);
          }
          if (undo.match(action)) {
            this.rta.undo();
          }
          if (redo.match(action)) {
            this.rta.redo();
          }
          if (reloadApplication.match(action)) {
            if (action.payload.save === true) {
              await this.save();
            }
            await this.rta.stop(false, true);
          }
          if (save.match(action)) {
            await this.save();
          }
        });
        this.rta.attachStop(() => {
          // eslint-disable-next-line @sap-ux/fiori-tools/sap-no-location-reload
          location.reload();
        });
        this.rta.attachStart(() => {
          resolve();
        });
        this.rta.attachModeChanged(modeAndStackChangeHandler(sendAction, this.rta));
      });
    }
    save() {
      if (this.rta.save) {
        // v1.107.x and above
        return this.rta.save();
      } else {
        // v1.71.x and above
        return this.rta?._serializeToLrep();
      }
    }
  }
  function modeAndStackChangeHandler(sendAction, rta) {
    return () => {
      const canUndo = rta.canUndo();
      const canRedo = rta.canRedo();
      const saveAllowed = rta?.canSave ? rta?.canSave() : canUndo; /* canSave v1.112.x and above only*/
      sendAction(setUndoRedoEnablement({
        canUndo,
        canRedo
      }));
      sendAction(setSaveEnablement(saveAllowed));
    };
  }
  var __exports = {
    __esModule: true
  };
  __exports.RtaService = RtaService;
  __exports.modeAndStackChangeHandler = modeAndStackChangeHandler;
  return __exports;
});
//# sourceMappingURL=rta-service.js.map